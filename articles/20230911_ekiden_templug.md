---
title: "素早く安全にプラグインにパッチを打つ"
emoji: "🐎"
type: "tech"
topics: ["vim"]
publication_name: "vim_jp"
published: false
---

この記事は[Vim駅伝](https://vim-jp.org/ekiden/)の2023年9月11日の記事です。

　私はVimのプラグイン開発者です。自分でもプラグインを作りますし、人のプラグインも使わせてもらっています。そうしていると必然的にバグと遭遇します。
　また、今回紹介する手法で使っている[ddu.vim](https://github.com/Shougo/ddu.vim)を含め、先端に近いプラグインを使っていると更新が激しいためバグと遭遇する確率は著しく上がります。
　この場合、自力で検証できるだけの知識がある場合に取る手段は大体2つになります。

- 検証したのち作者にバグ報告。直してくれるのを待つ
- 検証した情報を元にパッチを作成し、作者に取り込んでもらう

前者であれば、こちらがやることは検証してレポート作ることだけで直し方など考えなくてもいいので楽ではありますが、作者に負担がかかるためあまり好ましくはありません[^1]。それに直るまで古いバージョンを使い続けないといけなく不便でもあります。
そうなると、自力で直すことになるのですが、複製するのも怠惰な自分にとっては面倒な作業ですし、プラグインマネージャを使っている場合には差し替えるのにもちょっと手間がかかります[^2]。
そこで私がこの手間を減らすためにやっている設定について紹介しようと思います。

# templug

https://github.com/kuuote/dotvim/blob/051ab01841ae95587631c980b62a04165645b734/conf/dein.vim#L85-L95

まず、プラグインを素早く読み込むための設定をします。基本的にVimはruntimepathの先頭からスクリプトを読み込むため、プラグインマネージャがruntimepathを変更した直後に割り込んで、runtimepathの先頭に差し込むと大体上手く行きます。

検証のための機能なので、使いたい時だけ機能するのが好ましいです。そして設定はいじりたくありません。そのため、その場で切り替えられる機能として環境変数を採用しました。
`plug=on vim`や`plug=on nvim`のように起動すると`tmp/templug/*`に置かれているプラグインをruntimepathの先頭に差し込みます[^3]。

検証用の機能として、すぐに掃除するための`:TemplugClean`というコマンドも用意しています。


[^1]: この手のソフトウェアを作っている方々は基本的にボランティアのように余暇時間を使って対応しているため、あまり余裕が無いことがほとんどです。
[^2]: プラグインマネージャの定義を差し替える、差し替え機能を使うように設定を書き換える、runtimepathをどこかのタイミングで書き換える、など
[^3]: 知ってる人であればvim-pathogenがやる動きに近いと言った方が分かりやすいかもしれません。

<!--

バグ報告もいいことだけど理想ではないよね
  作者に負担がかかるのが単純によくない
    この手のソフトウェアを作っている人々は単純に忙しいことが多い
    自分みたいな気分屋もいる
      貰ったPRあるいはIssueを月単位で放置したりする
  直してもらうまで新機能が使えないという問題もある
  そもそも直せるレベルで検証できてるなら自分で直せばいいじゃん
    自分で直せばすぐ使える！
パッチ書きたいけど既存のプラギンとか設定破壊したくない
でもその場で試したい
起動時にプラギンを読み込む設定
  /tmp/templugに置いてフラグを立てるとプラギンのsource前に割り込む
  フラグが無いと何もしないので安全！
ddu.vimにrsyncアクションを生やしている
  rsyncに依存してるけどrsyncは福利厚生でしょう
  実行すると/tmp/templugに向けてrsyncが走りディレクトリトップが開かれる
  これにより別途cloneしなくても今使ってるプラギンが複製される、実際ハヤイ！

-->
